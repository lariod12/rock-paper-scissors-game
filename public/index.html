<!DOCTYPE html>
<html>

<head>
    <title>Rock Paper Scissors Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }

        .battle-arena {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
            position: relative;
        }

        .player-card {
            width: 300px;
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background: #f8f9fa;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .player-avatar {
            width: 120px;
            height: 120px;
            margin: 1rem auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
        }

        .health-bar-container {
            width: 100%;
            height: 20px;
            background: #e74c3c33;
            border-radius: 10px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.5s ease-in-out;
        }

        .choice-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            background: #2980b9;
        }

        .damage-animation {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px) rotate(-5deg);
            }

            75% {
                transform: translateX(10px) rotate(5deg);
            }
        }

        .winner-effect {
            animation: victory 1s ease-in-out infinite;
        }

        @keyframes victory {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        #result {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: #f1f8ff;
            border-radius: 8px;
            font-size: 1.2rem;
        }

        #waitingMessage {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin: 1rem 0;
        }

        /* Keep existing styles and add these new styles */
        .lobby-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .join-room-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        input[type="text"] {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            width: 200px;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        .room-code {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.2rem;
            margin: 1rem 0;
            border: 2px dashed #3498db;
        }

        .hidden {
            display: none !important;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .player-name {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .player-role {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-style: italic;
        }

        .current-player {
            border: 2px solid #3498db;
            background: #f7fbfe;
        }

        .opponent-card .health-bar-container,
        .opponent-card .player-avatar {
            opacity: 0;
            /* Hide opponent's health bar and avatar initially */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Rock Paper Scissors Battle</h1>

        <div id="initialLobby" class="lobby-container">
            <button onclick="createRoom()" class="choice-btn">T·∫°o ph√≤ng m·ªõi</button>
            <div class="join-room-container">
                <input type="text" id="roomInput" placeholder="Nh·∫≠p m√£ ph√≤ng">
                <button onclick="joinRoom()" class="choice-btn">V√†o ph√≤ng</button>
            </div>
            <div id="errorMessage" class="error"></div>
        </div>

        <div id="gameRoom" class="game-section hidden">
            <div id="roomInfo" class="room-code"></div>

            <div class="battle-arena">
                <div class="player-card" id="playerCard">
                    <div class="player-info">
                        <div class="player-name" id="playerName">Player</div>
                        <div class="player-role" id="playerRole">(B·∫°n)</div>
                    </div>
                    <div class="player-avatar">ü§∫</div>
                    <div class="health-bar-container">
                        <div class="health-bar" id="playerHealth"></div>
                    </div>
                </div>
            </div>

            <div id="gameControls" class="hidden">
                <button class="choice-btn" onclick="makeChoice('k√©o')">‚úåÔ∏è K√©o</button>
                <button class="choice-btn" onclick="makeChoice('b√∫a')">‚úä B√∫a</button>
                <button class="choice-btn" onclick="makeChoice('bao')">‚úã Bao</button>
            </div>
            <div id="result"></div>
            <div id="waitingMessage"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let isPlayer1 = false;
        let player1Health = 100;
        let player2Health = 100;
        const DAMAGE_AMOUNT = 20;
        let gameResultDisplayed = false; // Flag to track if game result is displayed

        // Add these new variables
        let playerHealth = 100;
        let opponentHealth = 100;

        // Add the new function
        function updatePlayerCard() {
            document.getElementById('playerName').textContent = isPlayer1 ? 'Player 1' : 'Player 2';
            document.getElementById('playerHealth').style.width = `${isPlayer1 ? player1Health : player2Health}%`;
        }

        // --- Socket event listeners ---
        socket.on('roomCreated', handleRoomCreated);
        socket.on('joinRoom', handleJoinRoom);
        socket.on('gameStart', handleGameStart);
        socket.on('gameResult', handleGameResult);
        socket.on('roomError', handleRoomError);
        socket.on('opponentMadeChoice', handleOpponentMadeChoice);
        socket.on('playerDisconnected', handlePlayerDisconnected);
        // --- End of Socket event listeners ---

        function updatePlayerLabels() {
            const currentPlayerCard = isPlayer1 ? 'player1Card' : 'player2Card';
            const otherPlayerCard = isPlayer1 ? 'player2Card' : 'player1Card';

            document.getElementById(currentPlayerCard).classList.add('current-player');
            document.getElementById(otherPlayerCard).classList.remove('current-player');

            if (isPlayer1) {
                document.getElementById('player1Role').textContent = '(B·∫°n)';
                document.getElementById('player2Role').textContent = '(ƒê·ªëi th·ªß)';
            } else {
                document.getElementById('player1Role').textContent = '(ƒê·ªëi th·ªß)';
                document.getElementById('player2Role').textContent = '(B·∫°n)';
            }
        }


        function updateHealth(loserPlayer) {
            if (loserPlayer === 'player1') {
                player1Health -= DAMAGE_AMOUNT;
                document.getElementById('player1Health').style.width = `${player1Health}%`;
            } else {
                player2Health -= DAMAGE_AMOUNT;
                document.getElementById('player2Health').style.width = `${player2Health}%`;
            }

            checkGameOver();
        }

        function animatePlayer(playerId) {
            const playerElement = document.getElementById(playerId);
            playerElement.classList.add('damage-animation');
            setTimeout(() => {
                playerElement.classList.remove('damage-animation');
            }, 500);
        }

        function checkGameOver() {
            if (player1Health <= 0 || player2Health <= 0) {
                const winner = player1Health <= 0 ? 'Ng∆∞·ªùi ch∆°i 2' : 'Ng∆∞·ªùi ch∆°i 1';
                document.getElementById('result').innerHTML = `${winner} th·∫Øng to√†n tr·∫≠n!`;
                document.getElementById('gameControls').classList.add('hidden');

                // Add victory effect to winner
                const winnerCard = player1Health <= 0 ? 'player2Card' : 'player1Card';
                document.getElementById(winnerCard).classList.add('winner-effect');

                // Reveal opponent's card and health bar after game over
                document.getElementById('player1Card').classList.remove('opponent-card');
                document.getElementById('player2Card').classList.remove('opponent-card');

                gameResultDisplayed = true; // Set flag to true

                setTimeout(resetGame, 3000);
            }
        }

        function resetGame() {
            player1Health = 100;
            player2Health = 100;
            document.getElementById('playerHealth').style.width = '100%';
            document.getElementById('result').innerHTML = '';
            document.getElementById('waitingMessage').innerHTML = '';
            document.getElementById('gameControls').classList.remove('hidden');
            document.getElementById('playerCard').classList.remove('winner-effect');
            gameResultDisplayed = false;
        }

        function resetHealth() {
            player1Health = 100;
            player2Health = 100;
            document.getElementById('player1Health').style.width = '100%';
            document.getElementById('player2Health').style.width = '100%';
        }

        function createRoom() {
            socket.emit('createRoom');
        }

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (roomId) {
                currentRoom = roomId;
                socket.emit('joinRoom', roomId);
                document.getElementById('initialLobby').classList.add('hidden');
                document.getElementById('gameRoom').classList.remove('hidden');
            } else {
                document.getElementById('errorMessage').innerHTML = 'Vui l√≤ng nh·∫≠p m√£ ph√≤ng';
            }
        }

        function makeChoice(choice) {
            socket.emit('makeChoice', { roomId: currentRoom, choice });
            document.getElementById('gameControls').classList.add('hidden');
            document.getElementById('waitingMessage').innerHTML = 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i kh√°c...';
        }


        // --- Socket event handler functions ---
        function handleRoomCreated(roomId) {
            currentRoom = roomId;
            isPlayer1 = true; // Room creator is Player 1
            document.getElementById('initialLobby').classList.add('hidden');
            document.getElementById('gameRoom').classList.remove('hidden');
            document.getElementById('roomInfo').innerHTML = `M√£ ph√≤ng: ${roomId}`;
            document.getElementById('waitingMessage').innerHTML = 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i kh√°c...';
            updatePlayerLabels();
            resetHealth();
            document.getElementById('player2Card').classList.add('opponent-card'); // Hide Player 2 initially
        }

        function handleJoinRoom(roomId) {
            isPlayer1 = false; // Joining player is Player 2
            currentRoom = roomId;
            updatePlayerLabels();
            document.getElementById('player1Card').classList.add('opponent-card'); // Hide Player 1 initially
        }

        function handleGameStart({ roomId }) {
            document.getElementById('waitingMessage').innerHTML = '';
            document.getElementById('gameControls').classList.remove('hidden');
            document.getElementById('roomInfo').innerHTML = `M√£ ph√≤ng: ${roomId}`;
            updatePlayerCard();
        }


        function handleGameResult({ player1Choice, player2Choice, result }) {
            let displayResult;
            if (result === 'H√≤a!') {
                displayResult = 'H√≤a!';
            } else {
                const isPlayerWinner = (isPlayer1 && result === 'player1') || (!isPlayer1 && result === 'player2');
                displayResult = isPlayerWinner ? 'B·∫°n th·∫Øng!' : 'ƒê·ªëi th·ªß th·∫Øng!';
            }

            const isCurrentPlayerLoser =
                (isPlayer1 && result === 'player2') ||
                (!isPlayer1 && result === 'player1');

            if (isCurrentPlayerLoser) {
                const currentHealth = isPlayer1 ? player1Health : player2Health;
                document.getElementById('playerHealth').style.width = `${currentHealth - DAMAGE_AMOUNT}%`;
                document.getElementById('playerCard').classList.add('damage-animation');
                setTimeout(() => {
                    document.getElementById('playerCard').classList.remove('damage-animation');
                }, 500);
            }

            document.getElementById('result').innerHTML = `
        L·ª±a ch·ªçn c·ªßa b·∫°n: ${isPlayer1 ? player1Choice : player2Choice}<br>
        K·∫øt qu·∫£: ${displayResult}`;

            if (!gameResultDisplayed) {
                document.getElementById('waitingMessage').innerHTML = 'ƒê·∫øn l∆∞·ª£t b·∫°n!';
                document.getElementById('gameControls').classList.remove('hidden');
            }
        }


        function handleRoomError(message) {
            document.getElementById('errorMessage').innerHTML = message;
            setTimeout(() => {
                document.getElementById('errorMessage').innerHTML = '';
            }, 3000);
        }


        function handleOpponentMadeChoice() {
            document.getElementById('waitingMessage').innerHTML = 'ƒê·ªëi th·ªß ƒë√£ ch·ªçn xong, ƒë·∫øn l∆∞·ª£t b·∫°n!';
        }

        function handlePlayerDisconnected() {
            alert('Ng∆∞·ªùi ch∆°i kh√°c ƒë√£ ng·∫Øt k·∫øt n·ªëi');
            location.reload();
        }
        // --- End of Socket event handler functions ---
    </script>
</body>

</html>